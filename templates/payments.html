{% extends 'base.html' %}

{% block title %}{{ _('payments.title') if _('payments.title') else 'Payments' }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
  <h1 class="text-lg font-semibold mb-4">{{ _('payments.for_member') }}: {{ member.name }} {{ member.surname }}</h1>

  <div class="bg-white border rounded p-4 mb-4">
    <h2 class="text-sm font-medium mb-2">{{ _('payments.add') }}</h2>
    <form method="post" action="/members/{{ member.id }}/payments/create" class="grid grid-cols-1 sm:grid-cols-6 gap-2 items-end">
      <div class="sm:col-span-2 col-span-6">
        <label class="block text-sm">{{ _('payments.month') }}</label>
        <select name="period_month" class="mt-1 w-full border rounded px-2 py-1">
          {% for m in range(1,13) %}
            {% if default_month and default_month == m %}
              <option value="{{ m }}" selected>{{ m }}</option>
            {% else %}
              <option value="{{ m }}">{{ m }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <div class="sm:col-span-1 col-span-6">
        <label class="block text-sm">{{ _('payments.year') }}</label>
        <input name="period_year" type="number" value="{{ default_year }}" class="mt-1 w-full border rounded px-2 py-1" />
      </div>

      <div class="sm:col-span-2 col-span-6">
        <label class="block text-sm">{{ _('payments.price') }}</label>
        <div class="mt-1">
          <select name="price_id" id="price_select" class="w-full border rounded px-2 py-1">
            <option value="">--</option>
            {% for p in prices %}
              <option value="{{ p.id }}" data-amount="{{ p.amount }}">{{ p.description }} ({{ p.amount }})</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="sm:col-span-1 col-span-6">
        <label class="block text-sm">&nbsp;</label>
        <div class="mt-1">
          <!-- match other inputs exactly for consistent height -->
          <input type="text" id="price_amount_display" aria-label="Selected price amount" disabled class="w-full mt-1 border rounded px-2 py-1 bg-gray-50 text-right" placeholder="0.00" />
        </div>
      </div>

      <div class="col-span-6 sm:col-start-1">
        <label class="block text-sm">{{ _('payments.notes') }}</label>
        <input name="notes" class="mt-1 w-full border rounded px-2 py-1" />
      </div>

      <div class="sm:col-span-6">
        <button class="px-3 py-2 bg-blue-600 text-white rounded">{{ _('payments.save') }}</button>
        <a href="/members" class="px-3 py-2 border rounded">{{ _('payments.cancel') }}</a>
      </div>
    </form>
  </div>

  {% if unpaid_months and unpaid_months > 0 %}
  <div class="bg-yellow-50 border rounded p-4 mb-4">
    <div class="flex items-center justify-between">
      <div class="text-sm text-yellow-800">{{ _('members.unpaid') }}: <span class="font-medium">{{ unpaid_months }}</span></div>
      <button type="button" id="toggle-unpaid-list" class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm">{{ _('members.unpaid_details') if _('members.unpaid_details') else 'Unpaid months' }}</button>
    </div>
    <div id="unpaid-list" class="mt-3 hidden text-sm text-gray-700">
      <ul class="list-disc pl-5 space-y-1">
        {% for mo in unpaid_months_list %}
          <li>{{ mo }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

   <div class="bg-white border rounded p-4">
     <h2 class="text-sm font-medium mb-2">{{ _('payments.history') }}</h2>
     {% if request.query_params.get('created') %}
       <div class="p-2 mb-3 bg-green-50 text-green-800 rounded text-sm">{{ _('payments.created') }}</div>
     {% endif %}
     {% if request.query_params.get('updated') %}
       <div class="p-2 mb-3 bg-green-50 text-green-800 rounded text-sm">{{ _('payments.updated') }}</div>
     {% endif %}
     {% if request.query_params.get('error') == 'duplicate' %}
       <div class="p-2 mb-3 bg-yellow-50 text-yellow-800 rounded text-sm">{{ _('payments.error_duplicate') }}</div>
     {% endif %}
     {% if request.query_params.get('error') == 'price_missing' %}
       <div class="p-2 mb-3 bg-red-50 text-red-800 rounded text-sm">{{ _('payments.error_price_missing') }}</div>
     {% endif %}

     {% if payments %}
       <!-- Mobile: stacked cards -->
       <div class="sm:hidden space-y-3">
         {% for pay in payments %}
           <article class="bg-white border rounded p-4 shadow-sm">
             <div>
               <div class="text-base font-medium">{{ pay.period_month }} / {{ pay.period_year }}</div>
               <div class="text-sm text-gray-600">{{ pay.price.description if pay.price else '' }}</div>
               <div class="text-sm font-medium text-gray-800">{{ pay.amount }}</div>
               {% if pay.notes %}
                 <div class="mt-2 text-sm text-gray-500">{{ pay.notes }}</div>
               {% endif %}
             </div>
             <div class="mt-3 text-sm flex flex-col items-stretch space-y-2">
               <a href="/members/{{ member.id }}/payments/{{ pay.id }}/edit" class="w-full inline-flex justify-center items-center px-3 py-2 bg-yellow-50 border border-yellow-100 text-yellow-800 rounded text-sm hover:bg-yellow-100">{{ _('payments.edit') }}</a>
               <form method="post" action="/members/{{ member.id }}/payments/{{ pay.id }}/delete" onsubmit="return confirm('{{ _('payments.confirm_delete') }}')" class="w-full">
                 <button class="w-full inline-flex justify-center items-center px-3 py-2 bg-red-50 border border-red-100 text-red-700 rounded text-sm hover:bg-red-100">{{ _('payments.delete') }}</button>
               </form>
             </div>
           </article>
         {% endfor %}
       </div>

       <!-- Desktop: table view -->
       <div class="hidden sm:block">
         <table class="w-full text-sm table-auto">
           <thead class="bg-gray-50">
             <tr>
               <th class="p-2 text-left">{{ _('payments.period') }}</th>
               <th class="p-2 text-left">{{ _('payments.amount') }}</th>
               <th class="p-2 text-left">{{ _('payments.price') }}</th>
               <th class="p-2 text-left">{{ _('payments.notes') }}</th>
               <th class="p-2 text-left">{{ _('payments.actions') }}</th>
             </tr>
           </thead>
           <tbody>
             {% for pay in payments %}
               <tr class="border-t">
                 <td class="p-2">{{ pay.period_month }} / {{ pay.period_year }}</td>
                 <td class="p-2">{{ pay.amount }}</td>
                 <td class="p-2">{{ pay.price.description if pay.price else '' }}</td>
                 <td class="p-2">{{ pay.notes or '' }}</td>
                 <td class="p-2">
                   <a href="/members/{{ member.id }}/payments/{{ pay.id }}/edit" class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm">{{ _('payments.edit') }}</a>
                   <form method="post" action="/members/{{ member.id }}/payments/{{ pay.id }}/delete" style="display:inline" onsubmit="return confirm('{{ _('payments.confirm_delete') }}')">
                     <button class="px-2 py-1 bg-red-100 text-red-700 rounded text-sm">{{ _('payments.delete') }}</button>
                   </form>
                 </td>
               </tr>
             {% endfor %}
           </tbody>
         </table>
       </div>

     {% else %}
       <div class="text-sm text-gray-600">{{ _('payments.none') }}</div>
     {% endif %}
   </div>
 </div>
 <script>
   (function(){
     function showAmount(sel){
       var disp = document.getElementById('price_amount_display');
       if(!disp || !sel) return;
       var val = sel.value;
       if(!val){ disp.value = ''; return; }
       var opt = sel.querySelector('option[value="'+val+'"]');
       var amt = opt ? opt.dataset.amount : '';
       if(amt !== undefined && amt !== ''){
         try{ disp.value = parseFloat(amt).toFixed(2); }catch(e){ disp.value = amt; }
       } else {
         disp.value = '';
       }
     }
     document.addEventListener('DOMContentLoaded', function(){
       var sel = document.getElementById('price_select');
       if(!sel) return;
       sel.addEventListener('change', function(){ showAmount(sel); });
       showAmount(sel);
     });
     // Toggle unpaid months list
     document.addEventListener('DOMContentLoaded', function(){
       var btn = document.getElementById('toggle-unpaid-list');
       var list = document.getElementById('unpaid-list');
       if(btn && list){
         btn.addEventListener('click', function(){ list.classList.toggle('hidden'); });
       }
     });
   })();
   </script>
{% endblock %}
